<!DOCTYPE html>
<!-- 
  CRÃTICO: AsegÃºrate de que 'xmlns:sec' estÃ© presente 
  para que sec:authorize funcione.
-->
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" 
      lang="es">
<head>
  <meta charset="UTF-8"><title>Reservas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link th:href="@{/css/estilos.css}" rel="stylesheet">
  <link th:href="@{/css/layout.css}" rel="stylesheet">
</head>
<body>
<div th:replace="fragments/headher :: headher"></div> 
<div th:replace="fragments/navibar :: navibar"></div>

<div class="container my-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Reservas</h3>
    <!-- El botÃ³n "Nueva reserva" es visible para todos los que ven esta pÃ¡gina 
         (CLIENTE, CAJERO, ADMIN) -->
    <a th:href="@{/reservas/crear}" class="btn btn-success btn-sm">+ Nueva reserva</a>
  </div>

  <div th:if="${ok}" class="alert alert-success" th:text="${ok}"></div>
  <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

  <!-- 
    CORRECCIÃ“N 1: Ocultar el formulario de filtros al CLIENTE.
    El Cliente (Paso 5) ya tiene sus reservas filtradas por el controlador.
    Solo ADMIN y CAJERO pueden filtrar la lista completa.
  -->
  <form class="card soft p-3 mb-3 shadow-sm" th:action="@{/reservas}" method="get"
        sec:authorize="hasAnyRole('ADMIN', 'CAJERO')">
    <div class="row g-3 align-items-end">
      <div class="col-12 col-md-3">
        <label class="form-label">Desde</label>
        <input type="date" class="form-control" name="desde" th:value="${desde}">
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">Hasta</label>
        <input type="date" class="form-control" name="hasta" th:value="${hasta}">
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">Cliente</label>
        <select class="form-select" name="clienteId">
          <option value="" th:selected="${clienteId == null}">â€” Todos â€”</option>
          <option th:each="c : ${clientes}"
                  th:value="${c.id}"
                  th:selected="${clienteId != null and clienteId == c.id}"
                  th:text="${(c.nombre ?: '') + ' ' + (c.apellido ?: '') + ' (#' + c.id + ')'}">
          </option>
        </select>
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">Mesa</label>
        <select class="form-select" name="mesaId">
          <option value="" th:selected="${mesaId == null}">â€” Todas â€”</option>
          <option th:each="m : ${mesas}"
                  th:value="${m.id}"
                  th:selected="${mesaId != null and mesaId == m.id}"
                  th:text="${'#' + m.id + ' â€” ' + (m.ubicacion ?: '') + ' (cap: ' + m.capacidad + ')'}">
          </option>
        </select>
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">Estatus</label>
        <select class="form-select" name="estatus">
          <option value="" th:selected="${estatus == null}">â€” Todos â€”</option>
          <option th:each="e : ${T(isa.restaurante.modelo.EstatusReserva).values()}"
                  th:value="${e}"
                  th:selected="${estatus == e}"
                  th:text="${e}">
          </option>
        </select>
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">Capacidad mÃ­nima</label>
        <input type="number" min="1" class="form-control" name="capacidadMin" th:value="${capacidadMin}">
      </div>
      <div class="col-6 col-md-2 d-grid">
        <button class="btn btn-primary">Filtrar</button>
      </div>
      <div class="col-6 col-md-2 d-grid">
        <a th:href="@{/reservas}" class="btn btn-light">Limpiar</a>
      </div>
    </div>
  </form>

  <div class="card soft">
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead>
        <tr>
          <th>#</th>
          <th>Fecha</th>
          <th>Hora</th>
          <th>Mesa</th>
          <th>Capacidad</th> 
          <th>Cliente</th>
          <th>Empleado</th>
          <th>Estatus</th>
          <th class="text-end">Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="r : ${reservas}">
          <td th:text="${r.id}">1</td>
          <td th:text="${r.fecha}">2025-10-12</td>
          <td th:text="${r.hora}">19:00</td>
          <td th:text="${r.mesa != null ? ('#' + r.mesa.id + ' â€” ' + (r.mesa.ubicacion ?: '')) : '-'}">#1</td>
          <td th:text="${r.mesa != null ? r.mesa.capacidad : '-'}">0</td>
          <td th:text="${r.cliente != null ? ((r.cliente.nombre ?: '') + ' ' + (r.cliente.apellido ?: '')) : '-'}">Cliente</td>
          <td th:text="${r.atendientesTexto}">â€”</td> 
          <td>
             <!-- Coloreado de Estatus -->
             <span class="badge" 
                   th:classappend="${r.estatus == T(isa.restaurante.modelo.EstatusReserva).CONFIRMADA ? 'bg-success' : 
                                    (r.estatus == T(isa.restaurante.modelo.EstatusReserva).CANCELADA ? 'bg-danger' : 'bg-warning text-dark')}"
                   th:text="${r.estatus}">PENDIENTE</span>
          </td>
          
          <!-- 
            ðŸš¨ CORRECCIÃ“N 2: LÃ³gica de Acciones por Rol
          -->
          <td class="text-end">
            <!-- Ver: Visible para todos (incluido el CLIENTE) -->
            <a th:href="@{/reservas/ver/{id}(id=${r.id})}" class="btn btn-sm btn-primary">Ver</a>
            
            <!-- 
              Editar y Cancelar: Solo visibles para ADMIN y CAJERO.
              El CLIENTE NO ve estos botones.
            -->
            <th:block sec:authorize="hasAnyRole('ADMIN', 'CAJERO')">
                <a th:href="@{/reservas/editar/{id}(id=${r.id})}" class="btn btn-sm btn-warning">Editar</a>
                
                <a th:href="@{/reservas/eliminar/{id}(id=${r.id})}"
                   class="btn btn-sm btn-danger"
                   onclick="return confirm('Â¿EstÃ¡ seguro de CANCELAR esta reserva?');">Cancelar ReservaciÃ³n</a>
            </th:block>
          </td>
        </tr>
        <tr th:if="${#lists.isEmpty(reservas)}">
          <td colspan="9" class="text-center text-muted py-4">No hay reservas.</td> 
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div th:replace="fragments/fhooter :: fhooter"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>