<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
  <meta charset="UTF-8">
  <title>Nueva asignación</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link th:href="@{/css/estilos.css}" rel="stylesheet">
  <link th:href="@{/css/layout.css}" rel="stylesheet">
</head>
<body class="bg-light py-4">
<div th:replace="fragments/headher :: headher"></div>
<div th:replace="fragments/navibar :: navibar"></div>

<div class="container">
  <div class="card soft shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Nueva asignación de atención</h5>
      <a th:href="@{/atender}" class="btn btn-light btn-sm">Volver</a>
    </div>

    <div class="card-body">
      <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

      <!-- ✅ validación cliente: exactamente uno (pedido o reserva) -->
      <form th:action="@{/atender/guardar}" th:object="${asignacion}" method="post" onsubmit="return validarDestino();">
        <input type="hidden" th:field="*{id}"/>

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Fecha de asignación</label>
            <input type="date" th:field="*{fechaAsignacion}" class="form-control" required>
          </div>

          <div class="col-md-8">
            <label class="form-label">Empleado</label>
            <select class="form-select" th:field="*{empleado.id}" required>
              <option value="" disabled selected>— Selecciona empleado —</option>
              <option th:each="e : ${empleados}" th:value="${e.id}" th:text="${e.nombreCompleto}">Empleado</option>
            </select>
          </div>

          <!-- Selector exclusivo: Pedido o Reserva -->
          <div class="col-12">
            <label class="form-label d-block">Asignar a</label>
            <div class="d-flex gap-3 align-items-center">

              <!-- ✅ el radio de Pedido queda checked cuando no hay reserva precargada -->
              <div class="form-check">
                <input class="form-check-input" type="radio" name="destinoTipo" id="destPedido" value="pedido"
                       th:checked="${asignacion.reserva == null}">
                <label class="form-check-label" for="destPedido">Pedido</label>
              </div>

              <select class="form-select" style="max-width:420px" th:field="*{pedido.id}" id="selPedido">
                <option value="">— Selecciona pedido —</option>
                <option th:each="p : ${pedidos}" th:value="${p.id}"
                        th:text="${'Pedido #' + p.id + (p.cliente != null ? ' — ' + p.cliente.nombre : '')}">
                </option>
              </select>

              <div class="form-check ms-4">
                <input class="form-check-input" type="radio" name="destinoTipo" id="destReserva" value="reserva"
                       th:checked="${asignacion.reserva != null}">
                <label class="form-check-label" for="destReserva">Reserva</label>
              </div>

              <select class="form-select" style="max-width:420px" th:field="*{reserva.id}" id="selReserva">
                <option value="">— Selecciona reserva —</option>
                <option th:each="r : ${reservas}" th:value="${r.id}"
                        th:text="${'Reserva #' + r.id
                                 + (r.cliente != null ? ' — ' + r.cliente.nombre : '')
                                 + ' — ' + (r.fecha != null ? r.fecha : '')
                                 + ' ' + (r.hora != null ? r.hora : '')
                                 + (r.mesa != null ? ' — Mesa ' + r.mesa.id : '')}">
                </option>
              </select>
            </div>
            <div class="form-text">
              Debe quedar seleccionado <strong>solo uno</strong>: Pedido o Reserva.
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">Observación</label>
            <input class="form-control" th:field="*{observacion}" placeholder="Turno, indicaciones, etc.">
          </div>
        </div>

        <div class="mt-4 d-flex gap-2">
          <a class="btn btn-secondary" th:href="@{/atender}">Cancelar</a>
          <button class="btn btn-primary" type="submit">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div th:replace="fragments/fhooter :: fhooter"></div>

<script>
  const destPedido  = document.getElementById('destPedido');
  const destReserva = document.getElementById('destReserva');
  const selPedido   = document.getElementById('selPedido');
  const selReserva  = document.getElementById('selReserva');

  function syncDestino() {
    const pedidoActivo = destPedido.checked;
    selPedido.disabled  = !pedidoActivo;
    selReserva.disabled =  pedidoActivo;

    if (pedidoActivo) {
      selReserva.value = "";
    } else {
      selPedido.value = "";
    }
  }

  function validarDestino(){
    const pedidoSel  = selPedido.value;
    const reservaSel = selReserva.value;
    if ((pedidoSel && reservaSel) || (!pedidoSel && !reservaSel)) {
      alert('Selecciona Pedido o Reserva (solo uno).');
      return false;
    }
    return true;
  }

  // inicializa el estado según radios (incluye caso de volver con errores)
  if (destPedido && destReserva) {
    destPedido.addEventListener('change', syncDestino);
    destReserva.addEventListener('change', syncDestino);
    syncDestino();
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>



