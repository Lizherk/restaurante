<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="es">
<head>
  <meta charset="UTF-8"><title>Pedidos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link th:href="@{/css/estilos.css}" rel="stylesheet">
  <link th:href="@{/css/layout.css}" rel="stylesheet">
</head>
<body>
<div th:replace="fragments/headher :: headher"></div>
<div th:replace="fragments/navibar :: navibar"></div>

<div class="container my-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Pedidos</h3>
    <div class="d-flex gap-2">
      <a th:href="@{/menu}" class="btn btn-outline-secondary btn-sm">← Ir al Menú</a>
      
      <!-- 
           1. CANDADO: Botón Nuevo Pedido
           Visible para ADMIN, CAJERO, MESERO. (Oculto para COCINERO)
      -->
      <a th:href="@{/pedidos/crear}" class="btn btn-success btn-sm"
         sec:authorize="hasAnyRole('ADMIN', 'CAJERO', 'MESERO')">+ Nuevo Pedido</a>
    </div>
  </div>

  <!-- Filtros -->
  <form class="card soft p-3 mb-3 shadow-sm" th:action="@{/pedidos}" method="get">
    <div class="row g-2 align-items-end">
        <div class="col-12 col-md-3"><label class="form-label">Desde</label><input type="date" class="form-control" name="desde" th:value="${desde}"></div>
        <div class="col-12 col-md-3"><label class="form-label">Hasta</label><input type="date" class="form-control" name="hasta" th:value="${hasta}"></div>
        <div class="col-12 col-md-3"><label class="form-label">Cliente</label>
          <select class="form-select" name="clienteId">
            <option value="" th:selected="${clienteId==null}">— Todos —</option>
            <option th:each="c : ${clientes}" th:value="${c.id}" th:selected="${clienteId!=null and clienteId==c.id}" th:text="${(c.nombre?:'') + ' ' + (c.apellido?:'') + ' (#' + c.id + ')'}"></option>
          </select>
        </div>
        <div class="col-12 col-md-3"><label class="form-label">Nombre contiene</label><input class="form-control" name="q" th:value="${q}" placeholder="ej. Juan"></div>
        <div class="col-6 col-md-2 d-grid mt-2 mt-md-0"><button class="btn btn-primary">Filtrar</button></div>
        <div class="col-6 col-md-2 d-grid mt-2 mt-md-0"><a th:href="@{/pedidos}" class="btn btn-light">Limpiar</a></div>
    </div>
  </form>

  <div class="row g-4">
    <div class="col-12 col-md-6 col-lg-4" th:each="c : ${cards}">
      <div class="card soft h-100 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center bg-dark text-white">
          <div>
            <div class="fw-semibold">Pedido #<span th:text="${c.id}">1</span></div>
            <div class="small text-white-50">Cliente: <span th:text="${c.clienteNombre}">Nombre</span></div>
            <div class="small mt-1"><span class="badge bg-info text-dark">Atiende: <span th:text="${c.atiendeNombre}">Sin asignar</span></span></div>
          </div>
          <span class="badge bg-success" th:text="${'$ ' + #numbers.formatDecimal(c.total,1,'POINT',2,'POINT')}">$0.00</span>
        </div>

        <div class="card-body">
          <div class="mb-3">
             <div class="text-muted small mb-1">Fecha</div>
             <div class="fw-semibold" th:text="${c.fecha}">2025-10-08</div>
          </div>
          <div class="text-muted small mb-2">Productos</div>
          <ul class="list-unstyled mb-0">
            <li th:each="it : ${c.items}" class="d-flex justify-content-between">
              <span th:text="${it.nombre}">Producto</span><span class="text-muted">x<span th:text="${it.cantidad}">1</span></span>
            </li>
            <li th:if="${#lists.size(c.items) < c.itemsCount}" class="text-muted small mt-2">+ <span th:text="${c.itemsCount - #lists.size(c.items)}">0</span> más…</li>
          </ul>
        </div>

        <div class="card-footer bg-light d-flex gap-2 justify-content-end">
          
          <!-- 
               2. CANDADO: Ticket PDF
               Visible para ADMIN, CAJERO, MESERO. (Oculto para COCINERO)
          -->
          <a th:href="@{/pedidos/exportar/{id}(id=${c.id})}" 
             class="btn btn-sm btn-outline-danger"
             sec:authorize="hasAnyRole('ADMIN', 'CAJERO', 'MESERO')">Ticket PDF</a>
          
          <!-- Ver: Visible para TODOS -->
          <a th:href="@{/pedidos/ver/{id}(id=${c.id})}" class="btn btn-primary btn-sm">Ver</a>
          
          <!-- 
               3. CANDADO: Botón Eliminar
               Visible para ADMIN, CAJERO.
               Visible para MESERO solo si es SU pedido.
               (Oculto para COCINERO siempre)
          -->
          <th:block sec:authorize="!hasRole('COCINERO')">
              <a th:if="${#authorization.expression('hasAnyRole(''ADMIN'', ''CAJERO'')') or (c.atiendeIds != null and empleadoIdActivo != null and #lists.contains(c.atiendeIds, empleadoIdActivo))}"
                 th:href="@{/pedidos/eliminar/{id}(id=${c.id})}"
                 class="btn btn-danger btn-sm"
                 onclick="return confirm('¿Eliminar este pedido?');">Eliminar</a>
          </th:block>
        </div>
      </div>
    </div>

    <div th:if="${#lists.isEmpty(cards)}" class="text-center text-muted mt-4"><p>No hay pedidos.</p></div>
  </div>
</div>
<div th:replace="fragments/fhooter :: fhooter"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

